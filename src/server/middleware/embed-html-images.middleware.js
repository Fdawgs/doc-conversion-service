const fs = require('fs');
const { JSDOM } = require('jsdom');
const path = require('path');

/**
 * @author Frazer Smith
 * @description Embeds images after encoding with Base64 to allow for
 * images to be transmitted via MESH.
 * @param {String=} tempDirectory - Directory where HTML docs and their images are
 * temporarily held after being generated by Poppler middleware.
 * Defaults to src/server/temp if not set.
 * @param {Boolean=} removeAltAtt - Remove alt attribute from content.
 * Useful for systems where recieved documents are converted to TIFF
 * (i.e. TPP's SystmOne).
 * @param {String=} imageFormat - Set the file format of images when embedded.
 * Defaults to the image file's original format if not set.
 * @return {Function} Express middleware.
 */
module.exports = function embedHtmlImagesMiddleware(
	tempDirectory,
	removeAltAtt,
	imageFormat
) {
	return async (req, res, next) => {
		const tempDir =
			tempDirectory || `${path.resolve(__dirname, '..')}\\temp\\`;
		const dom = new JSDOM(req.body);
		const images = dom.window.document.querySelectorAll('img');

		// Create results object for conversion results
		if (typeof req.results === 'undefined') {
			req.results = {};
		}

		try {
			images.forEach((element) => {
				const imgForm =
					imageFormat || path.extname(element.src).substring(1);
				const imageAsBase64 = `data:image/${imgForm};base64,${fs.readFileSync(
					tempDir + element.src,
					'base64'
				)}`;
				element.setAttribute('src', imageAsBase64);
				if (removeAltAtt) {
					element.setAttribute('alt', '');
				}
			});
			if (images.length > 0) {
				req.results.embedded_images = 'Fixed';
			}
			req.body = dom.window.document.documentElement.outerHTML;
		} catch (error) {
			req.results.embedded_images = error;
		}
		next();
	};
};
